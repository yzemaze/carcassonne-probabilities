<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Carcassonne Probability Analyzer</title>
<style>
    :root {
        color-scheme: light dark;
    }

    body {
        background-color: light-dark(#f4f4f4, #0c0c0c);
        font-family: sans-serif;
        font-size: 0.85em;
        color: light-dark(#333, #ccc);
        margin: 20px;
    }

    h2, h3, #footer {
        text-align: center;
        margin: 15px 0 10px 0;
    }

    .box-container {
        border-radius: 8px;
        background-color: light-dark(#fff, #333);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        display: grid;
        gap: 10px;
        margin: 0 auto 20px auto;
        padding: 15px;
        width: 90%;
        max-width: 600px;
    }

    .settings {
        display: grid;
        grid-template-columns: 2fr 1fr;
        align-items: center;
        gap: 5px;
    }

    fieldset {
        grid-column: 1 / -1;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px;
        background-color: transparent;
        margin-bottom: 5px;
    }

    legend {
        font-weight: bold;
        padding: 0 5px;
    }

    input, select {
        background-color: light-dark(#f9f9f9, #222);
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1em;
        padding: 2px 5px;
        color: light-dark(#333, #ccc);
    }

    button {
        padding: 5px 10px;
        background-color: light-dark(#4CAF50, #005B04);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

		button[disabled] {
				background-color: gray;
		}

    button:hover {
        filter: brightness(110%);
    }

    .action-btn {
        border: none;
        border-radius: 4px;
        cursor: pointer;
        padding: 1px 5px;
        line-height: 24px;
        font-size: 1.2em;
        font-weight: bold;
        text-align: center;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        vertical-align: middle;
        margin-left: 5px;
    }

    .add-btn {
        background-color: light-dark(#4CAF50, #005B04);
        color: white;
    }

    .remove-btn {
        background: #ff4d4d;
        color: white;
    }

    .full-width {
        grid-column: 1 / -1;
        margin-top: 5px;
    }

    pre {
        background-color: light-dark(#eee, #222);
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 4px;
        max-height: 400px;
        overflow: auto;
        font-family: monospace;
        font-size: 0.9em;
        margin: 0;
        white-space: pre-wrap;
        word-break: break-all;
    }

    .node {
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px;
        margin: 8px 0;
        background-color: light-dark(#fafafa, #2a2a2a);
    }

    .child {
        margin-left: 20px;
        border-left: 1px solid #ddd;
        padding-left: 10px;
    }

    .label {
        font-weight: bold;
        margin-right: 6px;
        color: light-dark(#555, #bbb);
    }

    #footer p {
        display: flex;
        justify-content: center;
        gap: 15px;
    }
    
    a {
        color: light-dark(#0066cc, #66b2ff);
        text-decoration: none;
    }
    a:hover {
        text-decoration: underline;
    }
</style>
</head>

<body>
<h2>Carcassonne Probability Analyzer</h2>

<div class="box-container">
    <div class="settings">
        <label for="totalTiles">Total tiles:</label>
        <input id="totalTiles" type="number" value="8" min="2" max="100">
    </div>
    <div class="settings">
        <label for="careTiles">Specific tiles:</label>
        <input id="careTiles" value="c,d" placeholder="e.g. c, d">
    </div>
    <div class="settings">
        <label for="sims">Simulations:</label>
        <input id="sims" type="number" value="100000" min="1000">
    </div>

    <fieldset>
        <legend>Logic Tree</legend>
        <div id="tree"></div>
    </fieldset>

    <button class="full-width" onclick="run()">Run Simulation</button>
</div>

<h3>Results</h3>
<div class="box-container">
    <pre id="out"></pre>
</div>

<div id="footer">
    <p>
        <a href="https://github.com/yzemaze/carcassonne-probabilities">Examples, feedback, source code etc.</a>
        <span>|</span>
        <a href="./carcassonne-draw-probabilities.html">Draw Simulator</a>
    </p>
</div>
<script>
/* =========================
   Utilities
========================= */
function shuffle(a) {
  for (let i=a.length-1;i>0;i--) {
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}

/* =========================
   Helpers for BEFORE logic
========================= */
function isBeforeBranch(el) {
  return el.classList.contains("child") &&
         (el.querySelector(".label")?.textContent === "EARLIER" ||
          el.querySelector(".label")?.textContent === "LATER");
}

function updateBeforeBranch(branch) {
  const hasNode = !!branch.querySelector(":scope > .node");

	branch.querySelectorAll(":scope > button").forEach(b => {
		b.disabled = hasNode;
	});
}

/* =========================
   Node creation
========================= */
const tree = document.getElementById("tree");

function createRoot() {
  const d = document.createElement("div");
  d.className = "node";
  d.dataset.type = "logic";
  d.innerHTML = `
    <span class="label">ROOT LOGIC</span>
    <select class="op">
      <option>AND</option>
      <option>OR</option>
      <option>XOR</option>
      <option>NAND</option>
      <option>NOR</option>
    </select>
    <button class="action-btn add-btn" onclick="addCondition(this.parentNode)" title="Add Condition">+Condition</button>
    <button class="action-btn add-btn" onclick="addLogic(this.parentNode)" title="Add Logic Group">+LogicGroup</button>
    <button class="action-btn add-btn" onclick="addBefore(this.parentNode)" title="Add BEFORE">+Before</button>
  `;
  tree.appendChild(d);
}

function addCondition(parent) {
  const d = document.createElement("div");
  d.className = "node child";
  d.dataset.type = "condition";
  d.innerHTML = `
    <span class="label">COND</span>
    <select class="player"><option>A</option><option>B</option></select>
    <select class="quant">
      <option>at least</option>
      <option>at most</option>
      <option>exactly</option>
    </select>
		draws <input class="num" type="number" value="1" min="0" style="width: 40px;">
    of <input class="tiles" value="" placeholder="c, d" style="width: 80px;">
    <button class="action-btn remove-btn" onclick="removeNode(this)" title="Remove">×</button>
  `;
  parent.appendChild(d);

  if (isBeforeBranch(parent)) updateBeforeBranch(parent);
}

function addLogic(parent) {
  const d = document.createElement("div");
  d.className = "node child";
  d.dataset.type = "logic";
  d.innerHTML = `
    <span class="label">LOGIC</span>
    <select class="op">
      <option>AND</option>
      <option>OR</option>
      <option>XOR</option>
      <option>NAND</option>
      <option>NOR</option>
    </select>
    <button class="action-btn add-btn" onclick="addCondition(this.parentNode)" title="Add Condition">+Condition</button>
    <button class="action-btn add-btn" onclick="addLogic(this.parentNode)" title="Add Logic Group">+LogicGroup</button>
    <button class="action-btn add-btn" onclick="addBefore(this.parentNode)" title="Add BEFORE">+Before</button>
    <button class="action-btn remove-btn" onclick="removeNode(this)" title="Remove">×</button>
  `;
  parent.appendChild(d);

  if (isBeforeBranch(parent)) updateBeforeBranch(parent);
}

function addBefore(parent) {
  const d = document.createElement("div");
  d.className = "node child";
  d.dataset.type = "before";
  d.innerHTML = `
    <span class="label">BEFORE</span>

    <div class="child">
      <span class="label">EARLIER</span>
    <button class="action-btn add-btn" onclick="addCondition(this.parentNode)" title="Add Condition">+Condition</button>
    <button class="action-btn add-btn" onclick="addLogic(this.parentNode)" title="Add Logic Group">+LogicGroup</button>
    </div>

    <div class="child">
      <span class="label">LATER</span>
    <button class="action-btn add-btn" onclick="addCondition(this.parentNode)" title="Add Condition">+Condition</button>
    <button class="action-btn add-btn" onclick="addLogic(this.parentNode)" title="Add Logic Group">+LogicGroup</button>
    </div>

    <button class="action-btn remove-btn" onclick="removeNode(this)" title="Remove">×</button>
  `;
  parent.appendChild(d);
}

function removeNode(btn) {
  const node = btn.parentNode;
  const parent = node.parentNode;
  node.remove();

  if (isBeforeBranch(parent)) {
    updateBeforeBranch(parent);
  }
}

/* =========================
   Evaluation
========================= */
function evalNode(node, draws) {
  const type = node.dataset.type;

  if (type === "condition") {
    const player = node.querySelector(".player").value;
    const quant = node.querySelector(".quant").value;
    const num = +node.querySelector(".num").value;
    const tiles = new Set(
      node.querySelector(".tiles").value.split(",").map(x=>x.trim()).filter(Boolean)
    );

    let count = 0;
    let firstTurn = null;

    draws.forEach((d,i)=>{
      if (d.player===player && tiles.has(d.tile)) {
        count++;
        if (firstTurn===null) firstTurn=i;
      }
    });

    let ok=false;
    if (quant==="at least") ok = count>=num;
    if (quant==="at most") ok = count<=num;
    if (quant==="exactly") ok = count===num;

    return { ok, turn:firstTurn };
  }

  if (type === "before") {
    const branches = [...node.children].filter(c => c.classList.contains("child"));
    const left = branches[0].querySelector(".node");
    const right = branches[1].querySelector(".node");

    if (!left || !right) return { ok:false };

    const a = evalNode(left,draws);
    const b = evalNode(right,draws);

    return {
      ok: a.ok && b.ok && a.turn < b.turn
    };
  }

  if (type === "logic") {
    const op = node.querySelector(".op").value;
    const kids = [...node.children].filter(x=>x.dataset?.type);
    const rs = kids.map(k=>evalNode(k,draws).ok);

    if (op==="AND") return { ok: rs.every(Boolean) };
    if (op==="OR") return { ok: rs.some(Boolean) };
    if (op==="XOR") return { ok: rs.filter(Boolean).length===1 };
    if (op==="NAND") return { ok: !rs.every(Boolean) };
    if (op==="NOR") return { ok: !rs.some(Boolean) };
  }
}

/* =========================
   Run
========================= */
function run() {
  const total = +totalTiles.value;
  const care = careTiles.value.split(",").map(x=>x.trim()).filter(Boolean);
  const sims = +document.getElementById("sims").value;

  let met = 0;
  const perms = new Set();

  for (let i=0;i<sims;i++) {
    const deck=[];
    for (let j=0;j<total;j++) deck.push(care[j]||"_");
    shuffle(deck);

    const draws = deck.map((t,i)=>({ tile:t, player:i%2===0?"A":"B" }));

    if (evalNode(tree.firstElementChild,draws).ok) {
      met++;
      perms.add(deck.map(t=>care.includes(t)?t:"_").join(","));
    }
  }

  const notMet = sims - met;

  out.textContent =
`Simulations: ${sims}

Conditions met:
  ${met} (${(met/sims*100).toFixed(2)}%)

Conditions not met:
  ${notMet} (${(notMet/sims*100).toFixed(2)}%)

Winning permutations (${perms.size}):
${[...perms].sort().join("\n")}`;
}

/* init */
createRoot();
</script>
</body>
</html>
